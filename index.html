<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Tienda Iglesia</title>
    <style>
        /* --- Estilos Generales y Variables --- */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --light-color: #ffffff;
            --dark-color: #2c3e50;
            --background-color: #ecf0f1;
            --highlight-color: #d4edda; /* Color para resaltar selección */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--dark-color);
            margin: 0;
            padding-bottom: 100px;
        }

        /* --- Estructura Principal --- */
        header {
            background-color: var(--primary-color);
            color: var(--light-color);
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            text-align: center;
            margin: 0;
            font-size: 1.5rem;
        }

        nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 1rem;
        }

        nav button {
            background: none;
            border: 1px solid var(--light-color);
            color: var(--light-color);
            padding: 0.5rem 1rem;
            margin: 0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        nav button.active {
            background-color: var(--light-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        main {
            padding: 1rem;
        }

        .view { display: none; }
        .view.active { display: block; }

        /* --- Componentes Generales --- */
        .card {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .card h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: white;
        }

        .item-list .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #eee;
            gap: 0.5rem;
        }
        .item-list .item:last-child { border-bottom: none; }
        .item .details { flex-grow: 1; }
        .item .details p { margin: 0; }
        .item .details .description { font-size: 1rem; }
        .item .details .meta { font-size: 0.8rem; color: #7f8c8d; }
        .item .amount { font-weight: bold; font-size: 1.1rem; }
        .item .amount.credit { color: var(--danger-color); }
        .item .amount.cash { color: var(--secondary-color); }

        .item-actions-sale { display: flex; gap: 0.5rem; }
        .item-actions-sale button { background: none; border: 1px solid #ccc; padding: 0.3rem 0.6rem; border-radius: 5px; cursor: pointer; }
        
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 999;
        }
        
        .btn-primary { background: var(--secondary-color); color: white; }
        .btn-secondary { background: #ccc; color: #333; }
        .btn-danger { background: var(--danger-color); color: white; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .form-actions button { padding: 0.8rem 1.2rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .hidden { display: none !important; }

        /* --- Notificación Toast --- */
        .toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--danger-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 2000;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
        }
        .toast-notification.show {
            opacity: 1;
            bottom: 30px;
        }

        /* --- Vista de Resumen (Dashboard) --- */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .summary-card {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .summary-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        .summary-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark-color);
        }
        .summary-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .summary-card li {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .summary-card li:last-child {
            border-bottom: none;
        }

        /* --- Vista de Ventas: Cuadro de Resumen --- */
        .daily-summary-container {
            display: flex;
            gap: 1rem;
            align-items: stretch;
            flex-wrap: wrap;
        }
        .daily-summary-container .date-selector-card {
            flex: 1;
            min-width: 200px;
        }
        .daily-summary-container .total-sales-card {
            flex: 2;
            background-color: var(--dark-color);
            color: var(--light-color);
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            min-width: 240px;
            padding: 0.5rem 1rem;
        }
        .total-section {
            text-align: center;
        }
        .total-sales-card h3 {
            margin: 0 0 0.25rem 0;
            color: var(--light-color);
            font-size: 0.8rem;
            font-weight: normal;
            text-transform: uppercase;
            border-bottom: none;
            padding-bottom: 0;
        }
        .total-sales-card .total-amount {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .total-amount.credit-amount {
            color: var(--danger-color);
        }
        .total-amount.cash-amount {
            color: var(--secondary-color);
        }

        /* --- Modal General --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 1rem;
            box-sizing: border-box;
        }

        .modal-content {
            background: var(--light-color);
            border-radius: 10px;
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-content h3 {
            padding: 1rem;
            margin: 0;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        /* --- Modal de Nueva Venta --- */
        .sale-container { display: flex; flex: 1; overflow: hidden; }
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
            overflow-y: auto;
            border-right: 1px solid #eee;
            align-content: flex-start;
        }
        .product-item {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            height: 55px; /* Altura reducida */
            box-sizing: border-box;
            user-select: none;
        }
        .product-item:active { transform: scale(0.98); }
        .product-item .name {
            font-weight: bold;
            font-size: 0.9rem;
        }
        .product-item.selected { background-color: var(--highlight-color); border-color: var(--secondary-color); }
        .product-counter {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .cart-container { flex: 1; display: flex; flex-direction: column; padding: 1rem; min-width: 280px; min-height: 0; }
        .cart-items { flex: 1; overflow-y: auto; }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
        }
        .cart-item .name {
            flex: 1;
            margin-right: 0.5rem;
            font-size: 0.9rem;
        }
        .cart-item .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 90px;
        }
        .cart-item .quantity-controls button {
            width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ccc;
            background-color: #f0f0f0; font-size: 1rem; cursor: pointer;
        }
        .cart-item .price {
            font-weight: bold;
            width: 80px;
            text-align: right;
        }

        .cart-summary { padding-top: 1rem; border-top: 1px solid #eee; }
        .cart-total { font-size: 1.5rem; font-weight: bold; text-align: right; margin-bottom: 1rem; }
        .payment-options { display: flex; gap: 10px; margin-bottom: 1rem; }
        .payment-btn { flex-grow: 1; padding: 0.8rem; border: 1px solid #ccc; background: #f0f0f0; border-radius: 5px; cursor: pointer; }
        .payment-btn.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        /* --- Vista de Inventario --- */
        .inventory-row {
            display: flex;
            align-items: center;
            padding: 0.8rem 0;
        }
        .inventory-row .details { flex: 1; }
        .inventory-row .amount { width: 90px; text-align: right; }
        .inventory-row .item-actions { width: 90px; text-align: center; }
        
        .inventory-header {
            font-weight: bold;
            border-bottom: 2px solid var(--dark-color);
            margin-bottom: 0.5rem;
        }
        #view-inventario .item {
            border-bottom: 1px solid #eee;
        }
        #view-inventario .item .item-actions button {
             padding: 0.4rem 0.8rem; border: none; border-radius: 5px; cursor: pointer;
        }

        /* --- Vista de Deudas --- */
        #view-deudas .debtor-item {
            cursor: pointer;
            flex-wrap: wrap;
        }
        .debt-details {
            width: 100%;
            background-color: #f8f9fa;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .debt-details h4 {
            margin: 0 0 0.75rem 0;
            color: var(--primary-color);
            font-size: 1rem;
        }
        .debt-details p {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }
         .debt-details p:last-child {
            margin-bottom: 0;
        }

        /* --- Vista de Historial --- */
        .history-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .history-filters .filter-btn-group {
            display: flex;
            gap: 5px;
        }
        .history-filters button {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .history-filters button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .history-filters .filter-input {
            flex-grow: 1;
        }

        /* --- Estilos para modal de formulario (Producto/Pago/Confirmación) --- */
        .modal-content.form-modal {
            height: auto;
            max-width: 400px;
            padding: 1.5rem;
        }
        .modal-content.form-modal h3 {
            padding: 0 0 1rem 0;
            margin-bottom: 1rem;
        }
        .modal-content.form-modal p {
            text-align: center;
            margin-top: 0;
        }
        
        /* --- Responsive --- */
        @media (max-width: 768px) {
            header h1 {
                display: none;
            }
            nav {
                margin-top: 0;
            }
            .date-selector-card {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 1rem;
            }
            .date-selector-card h2 {
                margin: 0;
                border: none;
                padding: 0;
                font-size: 1.25rem;
            }
            .date-selector-card .form-group {
                margin-bottom: 0;
                max-width: 150px;
            }
            .sale-container { 
                flex-direction: column; 
            }
            .product-list { 
                border-right: none; 
                border-bottom: 1px solid #eee; 
                flex-shrink: 0;
            }
            .total-sales-card .total-amount {
                font-size: 1.5rem;
            }
            .inventory-row .amount, .inventory-header .amount {
                width: 80px;
            }
             .inventory-row .item-actions, .inventory-header .item-actions {
                width: 80px;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>Tienda Iglesia</h1>
        <nav>
            <button class="active" data-view="resumen">Resumen</button>
            <button data-view="ventas">Ventas</button>
            <button data-view="deudas">Deudas</button>
            <button data-view="inventario">Inventario</button>
            <button data-view="historial">Historial</button>
        </nav>
    </header>

    <main>
        <!-- VISTA DE RESUMEN -->
        <div id="view-resumen" class="view active">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Ventas del Mes</h3>
                    <div id="summary-sales" class="value">$0</div>
                </div>
                <div class="summary-card">
                    <h3>Producto Estrella</h3>
                    <div id="summary-best-product" class="value">--</div>
                </div>
                <div class="summary-card">
                    <h3>Top Deudores</h3>
                    <ul id="summary-top-debtors">
                        <li>No hay deudas</li>
                    </ul>
                </div>
                <div class="summary-card">
                    <h3>Últimos Pagos</h3>
                    <ul id="summary-recent-payments">
                        <li>No hay pagos</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- VISTA DE VENTAS -->
        <div id="view-ventas" class="view">
            <div class="daily-summary-container">
                <div class="card date-selector-card">
                    <h2>Registro del Día</h2>
                    <input type="date" id="fecha-seleccionada" class="form-group">
                </div>
                <div class="card total-sales-card">
                    <div class="total-section">
                        <h3>Total Ventas</h3>
                        <div id="daily-total-amount" class="total-amount">$0</div>
                    </div>
                    <div class="total-section">
                        <h3>Contado</h3>
                        <div id="daily-cash-amount" class="total-amount cash-amount">$0</div>
                    </div>
                    <div class="total-section">
                        <h3>Crédito</h3>
                        <div id="daily-credit-amount" class="total-amount credit-amount">$0</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div id="lista-transacciones" class="item-list"></div>
            </div>
        </div>

        <!-- VISTA DE DEUDAS -->
        <div id="view-deudas" class="view">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2>Saldos</h2>
                    <div class="debt-toggle">
                        <span>Mostrar clientes al día</span>
                        <label class="switch">
                            <input type="checkbox" id="debt-toggle-switch">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="lista-deudores" class="item-list"></div>
            </div>
        </div>

        <!-- VISTA DE INVENTARIO -->
        <div id="view-inventario" class="view">
            <div class="card">
                <h2>Gestión de Productos</h2>
                <div class="inventory-row inventory-header">
                    <div class="details">Producto</div>
                    <div class="amount">Precio</div>
                    <div class="item-actions">Acciones</div>
                </div>
                <div id="lista-inventario" class="item-list"></div>
                <div class="form-actions" style="justify-content: center; margin-top: 1rem;">
                    <button id="btn-abrir-modal-producto" class="btn-primary">Añadir Nuevo Producto</button>
                </div>
            </div>
        </div>
        
        <!-- VISTA DE HISTORIAL -->
        <div id="view-historial" class="view">
            <div class="card">
                <h2>Historial de Ventas</h2>
                <div class="history-filters">
                    <div class="filter-btn-group">
                        <button class="filter-btn active" data-filter="all">Ver Todo</button>
                        <button class="filter-btn" data-filter="month">Mes</button>
                        <button class="filter-btn" data-filter="day">Día</button>
                    </div>
                    <input type="month" id="history-month-input" class="filter-input hidden">
                    <input type="date" id="history-day-input" class="filter-input hidden">
                </div>
                <div id="history-total" style="text-align: right; font-weight: bold; margin-bottom: 1rem;"></div>
            </div>
            <div class="card">
                <div id="lista-historial" class="item-list"></div>
            </div>
        </div>
    </main>

    <button class="fab" id="btn-nueva-venta" class="hidden">+</button>

    <!-- MODALES -->
    <div id="modal-container">
        <!-- Los modales se insertarán aquí con JS para mantener el HTML limpio -->
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- BASE DE DATOS TEMPORAL ---
    let productos = [
        { id: 1, nombre: 'Empanadas', precio: 2500 },
        { id: 2, nombre: 'Empanadas pequeñas', precio: 2000 },
        { id: 3, nombre: 'Papas rellenas', precio: 3500 },
        { id: 4, nombre: 'Pasteles de pollo', precio: 3500 },
        { id: 5, nombre: 'Café con leche', precio: 2500 },
        { id: 6, nombre: 'Tinto', precio: 1300 },
        { id: 7, nombre: 'Aromática', precio: 1000 },
        { id: 8, nombre: 'Gaseosa 7onz', precio: 1500 },
        { id: 9, nombre: 'Chocolate con leche', precio: 2500 },
    ];

    let clientes = [
        { id: 1, nombre: 'Ana García' },
        { id: 2, nombre: 'Carlos Ruiz' },
        { id: 3, nombre: 'Luisa Fernanda' },
        { id: 4, nombre: 'David Vélez' },
        { id: 5, nombre: 'James Rodríguez' },
    ];

    let transacciones = [
        {id: 1720401878356, fecha: "2025-07-07", descripcion: "Empanadas (x1)", valor: 2500, metodo_pago: "efectivo", cliente_id: 5, estado_deuda: "pagada"},
        {id: 1720401893043, fecha: "2025-07-07", descripcion: "Papas rellenas (x2), Gaseosa 7onz (x1)", valor: 8500, metodo_pago: "credito", cliente_id: 2, estado_deuda: "pendiente"},
        {id: 1720401905831, fecha: "2025-07-06", descripcion: "Café con leche (x1), Pasteles de pollo (x1)", valor: 6000, metodo_pago: "credito", cliente_id: 1, estado_deuda: "pendiente"}
    ];
    let pagos = [
        {id: 1720401920275, cliente_id: 1, monto: 2000, fecha: "2025-07-07"}
    ];
    let currentCart = [];

    // --- REFERENCIAS A ELEMENTOS DEL DOM ---
    const navButtons = document.querySelectorAll('nav button');
    const views = document.querySelectorAll('.view');
    const fechaInput = document.getElementById('fecha-seleccionada');
    const listaTransaccionesEl = document.getElementById('lista-transacciones');
    const dailyTotalAmountEl = document.getElementById('daily-total-amount');
    const dailyCashAmountEl = document.getElementById('daily-cash-amount');
    const dailyCreditAmountEl = document.getElementById('daily-credit-amount');
    const listaDeudoresEl = document.getElementById('lista-deudores');
    const debtToggleSwitch = document.getElementById('debt-toggle-switch');
    const listaInventarioEl = document.getElementById('lista-inventario');
    const btnNuevaVenta = document.getElementById('btn-nueva-venta');
    const modalContainer = document.getElementById('modal-container');
    const historyFilterBtns = document.querySelectorAll('.filter-btn');
    const historyMonthInput = document.getElementById('history-month-input');
    const historyDayInput = document.getElementById('history-day-input');
    
    // --- PLANTILLAS DE MODALES ---
    const modalTemplates = {
        nuevaVenta: `
            <div id="modal-nueva-transaccion" class="modal-overlay">
                <div class="modal-content">
                    <h3 id="sale-modal-title">Nueva Venta</h3>
                    <div class="sale-container">
                        <div class="product-list" id="modal-product-list"></div>
                        <div class="cart-container">
                            <div class="cart-items" id="modal-cart-items"><p>Selecciona productos...</p></div>
                            <div class="cart-summary">
                                <div class="cart-total" id="modal-cart-total">Total: $0</div>
                                <form id="form-nueva-transaccion">
                                    <input type="hidden" id="sale-id">
                                    <div class="form-group" style="margin-bottom: 0.5rem;">
                                        <select id="cliente-id" required>
                                            <option value="">Seleccione un comprador...</option>
                                        </select>
                                    </div>
                                    <div class="payment-options">
                                        <button type="button" class="payment-btn" data-method="efectivo">Efectivo</button>
                                        <button type="button" class="payment-btn" data-method="transferencia">Transferencia</button>
                                        <button type="button" class="payment-btn" data-method="credito">Crédito</button>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn-cancelar btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn-primary">Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`,
        registrarPago: `
            <div id="modal-registrar-pago" class="modal-overlay">
                <div class="modal-content form-modal">
                    <h3 id="pago-titulo-cliente">Registrar Pago</h3>
                    <p>Deuda actual: <strong id="pago-deuda-actual"></strong></p>
                    <form id="form-registrar-pago">
                        <input type="hidden" id="pago-cliente-id">
                        <div class="form-group"><label for="pago-monto">Monto a Pagar ($)</label><input type="number" id="pago-monto" required></div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancelar btn-secondary">Cancelar</button>
                            <button type="submit" class="btn-primary">Registrar Pago</button>
                        </div>
                    </form>
                </div>
            </div>`,
        producto: `
            <div id="modal-producto" class="modal-overlay">
                <div class="modal-content form-modal">
                    <h3 id="producto-modal-title">Gestionar Producto</h3>
                    <form id="form-producto">
                        <input type="hidden" id="producto-id">
                        <div class="form-group"><label for="producto-nombre">Nombre</label><input type="text" id="producto-nombre" required></div>
                        <div class="form-group"><label for="producto-precio">Precio ($)</label><input type="number" id="producto-precio" required></div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancelar btn-secondary">Cancelar</button>
                            <button type="submit" class="btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>`,
        confirmarEliminacion: `
            <div id="modal-confirmar-eliminacion" class="modal-overlay">
                <div class="modal-content form-modal">
                    <h3>Confirmar Eliminación</h3>
                    <p>¿Está seguro de que desea eliminar esta venta? Esta acción no se puede deshacer.</p>
                    <div class="form-actions">
                        <button type="button" class="btn-cancelar btn-secondary">Cancelar</button>
                        <button type="button" id="btn-confirmar-eliminar" class="btn-danger">Eliminar</button>
                    </div>
                </div>
            </div>`
    };

    function openModal(modalName, setupCallback) {
        modalContainer.innerHTML = modalTemplates[modalName];
        if (setupCallback) setupCallback();
        modalContainer.querySelector('.modal-overlay').classList.remove('hidden');
        modalContainer.querySelector('.btn-cancelar').addEventListener('click', closeModal);
    }

    function closeModal() {
        modalContainer.innerHTML = '';
    }

    // --- LÓGICA DE LA APLICACIÓN ---
    function showToast(message, type = 'error') {
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) {
            existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        if (type === 'success') {
            toast.style.backgroundColor = 'var(--secondary-color)';
        }
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }

    function getTodayString() { return new Date().toISOString().split('T')[0]; }
    function formatCurrency(value) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value); }

    // --- Lógica de Vistas ---
    function switchView(viewName) {
        navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewName));
        views.forEach(view => view.classList.toggle('active', view.id === `view-${viewName}`));
        btnNuevaVenta.classList.toggle('hidden', viewName !== 'ventas');
        
        switch(viewName) {
            case 'resumen': renderResumen(); break;
            case 'ventas': renderizarVentas(fechaInput.value); break;
            case 'deudas': renderizarDeudores(); break;
            case 'inventario': renderizarInventario(); break;
            case 'historial': renderizarHistorial(); break;
        }
    }

    // --- Lógica del Dashboard ---
    function renderResumen() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const monthlySales = transacciones
            .filter(t => {
                const txDate = new Date(t.fecha);
                return txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear;
            })
            .reduce((sum, t) => sum + t.valor, 0);
        document.getElementById('summary-sales').textContent = formatCurrency(monthlySales);

        const productCounts = {};
        transacciones
            .filter(t => {
                const txDate = new Date(t.fecha);
                return txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear;
            })
            .forEach(t => {
                const items = t.descripcion.split(', ');
                items.forEach(itemString => {
                    const match = itemString.match(/(.+) \(x(\d+)\)/);
                    if (match) {
                        const [, nombre, cantidad] = match;
                        productCounts[nombre] = (productCounts[nombre] || 0) + parseInt(cantidad);
                    }
                });
            });
        
        let bestProduct = '--';
        let maxCount = 0;
        for (const product in productCounts) {
            if (productCounts[product] > maxCount) {
                maxCount = productCounts[product];
                bestProduct = product;
            }
        }
        document.getElementById('summary-best-product').textContent = bestProduct;

        const balances = calcularBalances();
        const topDebtors = Object.values(balances)
            .filter(b => b.saldo > 0)
            .sort((a, b) => b.saldo - a.saldo)
            .slice(0, 3);
        
        const topDebtorsEl = document.getElementById('summary-top-debtors');
        topDebtorsEl.innerHTML = '';
        if (topDebtors.length > 0) {
            topDebtors.forEach(d => {
                topDebtorsEl.innerHTML += `<li><span>${d.cliente.nombre}</span> <strong>${formatCurrency(d.saldo)}</strong></li>`;
            });
        } else {
            topDebtorsEl.innerHTML = '<li>No hay deudas pendientes</li>';
        }

        const recentPayments = pagos.slice(-3).reverse();
        const recentPaymentsEl = document.getElementById('summary-recent-payments');
        recentPaymentsEl.innerHTML = '';
        if (recentPayments.length > 0) {
            recentPayments.forEach(p => {
                const cliente = clientes.find(c => c.id === p.cliente_id);
                recentPaymentsEl.innerHTML += `<li><span>${cliente.nombre}</span> <strong>${formatCurrency(p.monto)}</strong></li>`;
            });
        } else {
            recentPaymentsEl.innerHTML = '<li>No se han recibido pagos</li>';
        }
    }

    // --- Lógica de Ventas ---
    function renderizarVentas(fecha) {
        listaTransaccionesEl.innerHTML = '';
        const transaccionesDelDia = transacciones.filter(t => t.fecha === fecha);
        
        let totalContado = 0;
        let totalDelDia = 0;
        let totalCredito = 0;

        if (transaccionesDelDia.length === 0) {
            listaTransaccionesEl.innerHTML = '<p>No hay ventas registradas para este día.</p>';
        } else {
            transaccionesDelDia.forEach(t => {
                const cliente = clientes.find(c => c.id === t.cliente_id);
                const itemEl = document.createElement('div');
                itemEl.className = 'item';
                let amountClass = t.metodo_pago === 'credito' ? 'credit' : 'cash';
                
                itemEl.innerHTML = `
                    <div class="details">
                        <p class="description">${t.descripcion}</p>
                        <p class="meta">${cliente ? cliente.nombre : 'N/A'} - ${t.metodo_pago}</p>
                    </div>
                    <div class="amount ${amountClass}">${formatCurrency(t.valor)}</div>
                    <div class="item-actions-sale">
                        <button class="btn-editar-venta" data-id="${t.id}">✏️</button>
                        <button class="btn-eliminar-venta" data-id="${t.id}">🗑️</button>
                    </div>`;
                listaTransaccionesEl.appendChild(itemEl);
                
                totalDelDia += t.valor;
                if (t.metodo_pago === 'credito') {
                    totalCredito += t.valor;
                } else {
                    totalContado += t.valor;
                }
            });
        }
        
        dailyTotalAmountEl.textContent = formatCurrency(totalDelDia);
        dailyCashAmountEl.textContent = formatCurrency(totalContado);
        dailyCreditAmountEl.textContent = formatCurrency(totalCredito);
    }

    // --- Lógica de Deudas ---
    function calcularBalances() {
        const balances = {};
        clientes.forEach(c => {
            balances[c.id] = { cliente: c, totalDeuda: 0, totalPagado: 0, saldo: 0 };
        });
        transacciones.forEach(t => {
            if (t.metodo_pago === 'credito' && balances[t.cliente_id]) {
                balances[t.cliente_id].totalDeuda += t.valor;
            }
        });
        pagos.forEach(p => {
            if (balances[p.cliente_id]) {
                balances[p.cliente_id].totalPagado += p.monto;
            }
        });
        for (const id in balances) {
            balances[id].saldo = balances[id].totalDeuda - balances[id].totalPagado;
        }
        return balances;
    }

    function renderizarDeudores() {
        const showPaid = debtToggleSwitch.checked;
        listaDeudoresEl.innerHTML = '';
        const balances = calcularBalances();
        
        const deudores = Object.values(balances).filter(b => {
            if (showPaid) {
                return b.totalDeuda > 0 && b.saldo <= 0; // Tuvo deuda y está al día
            }
            return b.saldo > 0; // Tiene deuda pendiente
        });

        if (deudores.length === 0) {
            listaDeudoresEl.innerHTML = `<p>${showPaid ? 'No hay clientes al día.' : '¡Excelente! No hay deudas pendientes.'}</p>`;
            return;
        }

        deudores.forEach(({ cliente, totalDeuda, totalPagado, saldo }) => {
            const itemEl = document.createElement('div');
            itemEl.className = 'item debtor-item';
            itemEl.dataset.clienteId = cliente.id;
            itemEl.innerHTML = `
                <div class="details">
                    <p class="description">${cliente.nombre}</p>
                    <p class="meta">Deuda total: ${formatCurrency(totalDeuda)} | Pagado: ${formatCurrency(totalPagado)}</p>
                </div>
                <div class="item-actions">
                     <span class="amount ${saldo > 0 ? 'credit' : 'cash'}">${formatCurrency(saldo)}</span>
                     ${saldo > 0 ? `<button class="btn-pagar btn-primary" data-cliente-id="${cliente.id}" data-deuda-total="${saldo}">Abonar</button>` : ''}
                </div>`;
            listaDeudoresEl.appendChild(itemEl);
        });
    }

    // --- Lógica de Inventario ---
    function renderizarInventario() {
        listaInventarioEl.innerHTML = '';
        if (productos.length === 0) {
            listaInventarioEl.innerHTML = '<p>No hay productos en el inventario.</p>';
        } else {
            productos.forEach(p => {
                const itemEl = document.createElement('div');
                itemEl.className = 'item inventory-row';
                itemEl.innerHTML = `
                    <div class="details"><p class="description">${p.nombre}</p></div>
                    <div class="amount">${formatCurrency(p.precio)}</div>
                    <div class="item-actions">
                        <button class="btn-editar-producto btn-secondary" data-id="${p.id}">Editar</button>
                    </div>`;
                listaInventarioEl.appendChild(itemEl);
            });
        }
    }
    
    // --- Lógica de Historial ---
    function renderizarHistorial(filterType = 'all', filterValue = null) {
        const historyListEl = document.getElementById('lista-historial');
        const historyTotalEl = document.getElementById('history-total');
        historyListEl.innerHTML = '';
        
        let filteredTransactions = [...transacciones].sort((a, b) => b.id - a.id);

        if (filterType === 'day' && filterValue) {
            filteredTransactions = filteredTransactions.filter(t => t.fecha === filterValue);
        } else if (filterType === 'month' && filterValue) {
            filteredTransactions = filteredTransactions.filter(t => t.fecha.startsWith(filterValue));
        }

        let total = 0;
        if (filteredTransactions.length === 0) {
            historyListEl.innerHTML = '<p>No se encontraron ventas para este período.</p>';
        } else {
            filteredTransactions.forEach(t => {
                const cliente = clientes.find(c => c.id === t.cliente_id);
                const itemEl = document.createElement('div');
                itemEl.className = 'item';
                let amountClass = t.metodo_pago === 'credito' ? 'credit' : 'cash';
                
                itemEl.innerHTML = `
                    <div class="details">
                        <p class="description">${t.descripcion}</p>
                        <p class="meta">${t.fecha} - ${cliente ? cliente.nombre : 'N/A'} - ${t.metodo_pago}</p>
                    </div>
                    <div class="amount ${amountClass}">${formatCurrency(t.valor)}</div>`;
                historyListEl.appendChild(itemEl);
                total += t.valor;
            });
        }
        historyTotalEl.textContent = `Total del Período: ${formatCurrency(total)}`;
    }
    
    // --- Lógica de Modales y Formularios ---
    function setupVentaModal(transactionId = null) {
        const isEditMode = transactionId !== null;
        const modalTitle = document.getElementById('sale-modal-title');
        const productListEl = document.getElementById('modal-product-list');
        const cartItemsEl = document.getElementById('modal-cart-items');
        const cartTotalEl = document.getElementById('modal-cart-total');
        const selectCliente = document.getElementById('cliente-id');
        const paymentButtons = document.querySelectorAll('#modal-nueva-transaccion .payment-btn');
        const formVenta = document.getElementById('form-nueva-transaccion');
        const saleIdInput = document.getElementById('sale-id');
        currentCart = [];

        function renderProductsInModal() {
            productListEl.innerHTML = '';
            productos.forEach(p => {
                const itemEl = document.createElement('div');
                itemEl.className = 'product-item';
                itemEl.dataset.productId = p.id;
                itemEl.innerHTML = `<span class="name">${p.nombre}</span><span class="product-counter hidden"></span>`;
                
                let pressTimer;
                itemEl.addEventListener('click', () => addProductToCart(p.id));
                itemEl.addEventListener('touchstart', (e) => {
                    pressTimer = window.setTimeout(() => {
                        e.preventDefault();
                        removeProductFromCart(p.id);
                    }, 500);
                });
                itemEl.addEventListener('touchend', () => clearTimeout(pressTimer));
                itemEl.addEventListener('touchmove', () => clearTimeout(pressTimer));

                productListEl.appendChild(itemEl);
            });
        }

        function addProductToCart(productId) {
            const product = productos.find(p => p.id === productId);
            const existingItem = currentCart.find(item => item.id === productId);
            if (existingItem) existingItem.cantidad++;
            else currentCart.push({ ...product, cantidad: 1 });
            renderCart();
        }
        
        function removeProductFromCart(productId) {
            const existingItem = currentCart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.cantidad--;
                if (existingItem.cantidad <= 0) {
                    currentCart = currentCart.filter(item => item.id !== productId);
                }
                renderCart();
            }
        }

        function changeQuantity(productId, change) {
            const cartItem = currentCart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.cantidad += change;
                if (cartItem.cantidad <= 0) currentCart = currentCart.filter(item => item.id !== productId);
            }
            renderCart();
        }

        function renderCart() {
            if (currentCart.length === 0) {
                cartItemsEl.innerHTML = '<p>Selecciona productos de la lista...</p>';
                cartTotalEl.textContent = 'Total: $0';
            } else {
                cartItemsEl.innerHTML = '';
                let total = 0;
                currentCart.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.innerHTML = `
                        <span class="name">${item.nombre}</span>
                        <div class="quantity-controls">
                            <button type="button" class="btn-qty-change" data-id="${item.id}" data-change="-1">-</button>
                            <span>${item.cantidad}</span>
                            <button type="button" class="btn-qty-change" data-id="${item.id}" data-change="1">+</button>
                        </div>
                        <span class="price">${formatCurrency(item.precio * item.cantidad)}</span>`;
                    cartItemsEl.appendChild(itemEl);
                    total += item.precio * item.cantidad;
                });
                cartTotalEl.textContent = `Total: ${formatCurrency(total)}`;
            }
            updateProductSelection();
        }
        
        function updateProductSelection() {
            document.querySelectorAll('#modal-product-list .product-item').forEach(el => {
                const productId = parseInt(el.dataset.productId);
                const itemInCart = currentCart.find(item => item.id === productId);
                const counter = el.querySelector('.product-counter');

                if (itemInCart) {
                    el.classList.add('selected');
                    counter.textContent = itemInCart.cantidad;
                    counter.classList.remove('hidden');
                } else {
                    el.classList.remove('selected');
                    counter.classList.add('hidden');
                }
            });
        }
        
        function parseDescriptionToCart(description) {
            const items = description.split(', ');
            const cart = [];
            items.forEach(itemString => {
                const match = itemString.match(/(.+) \(x(\d+)\)/);
                if (match) {
                    const [, nombre, cantidad] = match;
                    const product = productos.find(p => p.nombre === nombre);
                    if (product) {
                        cart.push({ ...product, cantidad: parseInt(cantidad) });
                    }
                }
            });
            return cart;
        }

        // Setup
        modalTitle.textContent = isEditMode ? 'Editar Venta' : 'Nueva Venta';
        renderProductsInModal();
        selectCliente.innerHTML += clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
        
        if (isEditMode) {
            const tx = transacciones.find(t => t.id === transactionId);
            if (tx) {
                saleIdInput.value = tx.id;
                currentCart = parseDescriptionToCart(tx.descripcion);
                selectCliente.value = tx.cliente_id;
                paymentButtons.forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.method === tx.metodo_pago);
                });
                renderCart();
            }
        }

        // Event Listeners
        paymentButtons.forEach(button => button.addEventListener('click', () => {
            paymentButtons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
        }));
        
        cartItemsEl.addEventListener('click', e => {
            if (e.target.classList.contains('btn-qty-change')) {
                const productId = parseInt(e.target.dataset.id);
                const change = parseInt(e.target.dataset.change);
                changeQuantity(productId, change);
            }
        });

        formVenta.addEventListener('submit', e => {
            e.preventDefault();
            const metodoPago = document.querySelector('#modal-nueva-transaccion .payment-btn.selected')?.dataset.method;
            
            let errors = [];
            if (currentCart.length === 0) errors.push('Añada productos al carrito.');
            if (!selectCliente.value) errors.push('Seleccione un comprador.');
            if (!metodoPago) errors.push('Seleccione un método de pago.');

            if (errors.length > 0) {
                showToast(errors.join(' '));
                return;
            }
            
            const saleData = {
                fecha: fechaInput.value,
                descripcion: currentCart.map(item => `${item.nombre} (x${item.cantidad})`).join(', '),
                valor: currentCart.reduce((total, item) => total + (item.precio * item.cantidad), 0),
                metodo_pago: metodoPago,
                cliente_id: parseInt(selectCliente.value),
                estado_deuda: metodoPago === 'credito' ? 'pendiente' : 'pagada'
            };

            if (isEditMode) {
                const txId = parseInt(saleIdInput.value);
                const txIndex = transacciones.findIndex(t => t.id === txId);
                if (txIndex !== -1) {
                    transacciones[txIndex] = { ...transacciones[txIndex], ...saleData };
                }
            } else {
                 transacciones.unshift({ ...saleData, id: Date.now() });
            }

            closeModal();
            renderizarVentas(fechaInput.value);
            renderizarDeudores();
        });
    }

    function setupPagoModal(clienteId, deudaTotal) {
        const cliente = clientes.find(c => c.id == clienteId);
        document.getElementById('pago-cliente-id').value = clienteId;
        document.getElementById('pago-titulo-cliente').textContent = `Registrar Pago para ${cliente.nombre}`;
        document.getElementById('pago-deuda-actual').textContent = formatCurrency(deudaTotal);
        const montoInput = document.getElementById('pago-monto');
        montoInput.max = deudaTotal;
        montoInput.value = '';

        document.getElementById('form-registrar-pago').addEventListener('submit', e => {
            e.preventDefault();
            const monto = parseInt(montoInput.value);
            if (monto > 0) {
                pagos.push({ id: Date.now(), cliente_id: parseInt(clienteId), monto: monto, fecha: getTodayString() });
            }
            closeModal();
            renderizarDeudores();
        });
    }

    function setupProductoModal(producto = null) {
        const form = document.getElementById('form-producto');
        const title = document.getElementById('producto-modal-title');
        const idInput = document.getElementById('producto-id');
        const nombreInput = document.getElementById('producto-nombre');
        const precioInput = document.getElementById('producto-precio');

        if (producto) {
            title.textContent = 'Editar Producto';
            idInput.value = producto.id;
            nombreInput.value = producto.nombre;
            precioInput.value = producto.precio;
        } else {
            title.textContent = 'Añadir Nuevo Producto';
        }

        form.addEventListener('submit', e => {
            e.preventDefault();
            const id = parseInt(idInput.value);
            const updatedProduct = {
                id: id || Date.now(),
                nombre: nombreInput.value.trim(),
                precio: parseInt(precioInput.value)
            };

            if (!updatedProduct.nombre || isNaN(updatedProduct.precio) || updatedProduct.precio < 0) {
                showToast('Por favor, ingrese un nombre y precio válidos.');
                return;
            }

            if (id) { // Edit
                const index = productos.findIndex(p => p.id === id);
                if (index !== -1) productos[index] = updatedProduct;
            } else { // Add
                productos.push(updatedProduct);
            }
            closeModal();
            renderizarInventario();
        });
    }

    // --- EVENT LISTENERS GLOBALES ---
    function addEventListeners() {
        navButtons.forEach(button => button.addEventListener('click', () => switchView(button.dataset.view)));
        fechaInput.addEventListener('input', () => renderizarVentas(fechaInput.value));
        btnNuevaVenta.addEventListener('click', () => openModal('nuevaVenta', () => setupVentaModal()));
        
        listaTransaccionesEl.addEventListener('click', e => {
            const target = e.target.closest('button');
            if (!target) return;

            const transactionId = parseInt(target.dataset.id);

            if (target.classList.contains('btn-editar-venta')) {
                openModal('nuevaVenta', () => setupVentaModal(transactionId));
            }
            if (target.classList.contains('btn-eliminar-venta')) {
                openModal('confirmarEliminacion', () => {
                    document.getElementById('btn-confirmar-eliminar').onclick = () => {
                        transacciones = transacciones.filter(t => t.id !== transactionId);
                        closeModal();
                        renderizarVentas(fechaInput.value);
                        renderizarDeudores();
                    };
                });
            }
        });

        document.getElementById('view-deudas').addEventListener('click', e => {
            const payButton = e.target.closest('.btn-pagar');
            if (payButton) {
                e.stopPropagation();
                const clienteId = payButton.dataset.clienteId;
                const deudaTotal = payButton.dataset.deudaTotal;
                openModal('registrarPago', () => setupPagoModal(clienteId, deudaTotal));
                return;
            }
            
            const debtorItem = e.target.closest('.debtor-item');
            if (debtorItem) {
                const clienteId = parseInt(debtorItem.dataset.clienteId);
                const existingDetails = debtorItem.querySelector('.debt-details');

                if (existingDetails) {
                    existingDetails.remove();
                } else {
                    const creditosPendientes = transacciones.filter(t => t.cliente_id === clienteId && t.estado_deuda === 'pendiente');
                    if (creditosPendientes.length > 0) {
                        const detailsContainer = document.createElement('div');
                        detailsContainer.className = 'debt-details';
                        let detailsHTML = '<h4>Detalle de Créditos</h4>';
                        creditosPendientes.forEach(tx => {
                            detailsHTML += `<p><span>${tx.fecha}: ${tx.descripcion}</span> <strong>${formatCurrency(tx.valor)}</strong></p>`;
                        });
                        detailsContainer.innerHTML = detailsHTML;
                        debtorItem.appendChild(detailsContainer);
                    }
                }
            }
        });
        
        debtToggleSwitch.addEventListener('change', renderizarDeudores);

        document.getElementById('view-inventario').addEventListener('click', e => {
            const target = e.target;
            if (target.id === 'btn-abrir-modal-producto') {
                openModal('producto', () => setupProductoModal());
            } else if (target.classList.contains('btn-editar-producto')) {
                const id = parseInt(target.dataset.id);
                const producto = productos.find(p => p.id === id);
                openModal('producto', () => setupProductoModal(producto));
            }
        });

        // Event Listeners para Historial
        historyFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                historyFilterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const filter = btn.dataset.filter;
                historyMonthInput.classList.toggle('hidden', filter !== 'month');
                historyDayInput.classList.toggle('hidden', filter !== 'day');
                
                if (filter === 'all') {
                    renderizarHistorial('all');
                } else if (filter === 'month') {
                    renderizarHistorial('month', historyMonthInput.value);
                } else if (filter === 'day') {
                    renderizarHistorial('day', historyDayInput.value);
                }
            });
        });

        historyMonthInput.addEventListener('input', () => renderizarHistorial('month', historyMonthInput.value));
        historyDayInput.addEventListener('input', () => renderizarHistorial('day', historyDayInput.value));
    }

    // --- INICIALIZACIÓN ---
    function init() {
        const today = new Date();
        fechaInput.value = today.toISOString().split('T')[0];
        historyDayInput.value = today.toISOString().split('T')[0];
        historyMonthInput.value = today.toISOString().slice(0, 7);
        addEventListeners();
        switchView('resumen');
    }

    init();
});
</script>
</body>
</html>
